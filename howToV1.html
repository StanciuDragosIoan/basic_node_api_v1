<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Domine:wght@400;700&family=Open+Sans:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&family=Roboto&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./assets/css/main.css" type="text/css" />
    <title>Basic NodeJS API</title>
  </head>
  <body>
    <h1 class="header">How to Build a Basic NodeJS API</h1>

    <p class="text">
      An API <span class="snippet">Application Programming Interface</span> is a
      critical component for both front-end and back-end developers as all of
      them consume data from these APIs in their apps. In this post we will too
      build a very basic NodeJS API that will allow us to perform CRUD
      operations on our resources. We will later on refactor this little project
      in a more elegant form, but for starters this is good and it will teach
      you how to do a lot of basic things related to backend development.
    </p>
    <p class="text center bold">Setup</p>
    <p class="text">
      We will start with an empty directory (I named mine project). While inside
      that directory, let's initialize an npm package, so run:
    </p>
    <pre class="code">
      npm init
    </pre>
    <p class="text">
      This command will walk you through the basic steps of configuring your npm
      script:
    </p>
    <div class="devPic">
      <img src="./img/npm-init-1.png" alt="" />
    </div>
    <p class="text">
      Name the project, and next it will ask you for the version, you can type a
      specific one, or leave the field blank and it will put it as
      <span class="snippet">1.0.0</span> for you:
    </p>
    <div class="devPic">
      <img src="./img/npm-init-2.png" alt="" />
    </div>
    <p class="text">
      Next it will ask you for a description and an entry point:
    </p>
    <div class="devPic">
      <img src="./img/npm-init-3.png" alt="" />
    </div>
    <p class="text">
      It will also ask you for a test command and a git repo, but we will not
      include them for now so leave that blank and hit enter:
    </p>
    <div class="devPic">
      <img src="./img/npm-init-4.png" alt="" />
    </div>
    <p class="text">
      Next it will prompt you for some keywords, so let's just enter a bunch:
    </p>
    <div class="devPic">
      <img src="./img/npm-init-5.png" alt="" />
    </div>
    <p class="text">
      It will also ask you for an author so put your name there:
    </p>
    <div class="devPic">
      <img src="./img/npm-init-6.png" alt="" />
    </div>
    <p class="text">
      Next it wants a licence too, so add whatever or just leave it blank:
    </p>
    <div class="devPic">
      <img src="./img/npm-init-7.png" alt="" />
    </div>
    <p class="text">
      Before saving your <span class="snippet">package.json</span> configuration
      file, it will ask you once more to check everything. Hit enter to confirm:
    </p>
    <div class="devPic">
      <img src="./img/npm-init-8.png" alt="" />
    </div>
    <p class="text">
      Now we are all set and we can start working on the
      <span class="snippet">server.js</span> file. This will be the app entry
      point and the main file of our application. For the version
      <span class="snippet">1.0.0</span> of our application, we will use a very
      simplistic format (do not worry, you will learn a ton from building this
      little project) and put all of our code in one file.
    </p>
    <p class="text">
      Create the <span class="snippet">server.js</span> file and add the below
      code to it:
    </p>
    <pre class="code">
//import http module for our server
const http = require("http");

//define port for our server to listen to
const PORT = process.env.port || 5000;

//create server
const server = http.createServer((req, res) => {
  //define url
  const url = req.url;

  switch(url){
    case "/":
    //write client response
    res.write(`
            &lt;h1&gt;Welcome to our nodeJS API&lt;/h1&gt;
            &lt;p&gt;This is your first endpoint =)&lt;/p&gt;
        `);
    //send client response
    res.end();
    break;
  }
});

//log some output to see everything's ok
console.log(`
    Server is running on port: 
    ${PORT} so our API is alive =)`);

//start the server
server.listen(PORT);

    </pre>
    <p class="text">
      Next in the package.json file, remove the
      <span class="snippet">test</span> script add a
      <span class="snippet">start</span> one under the test one:
    </p>
    <pre class="code">
      {
        "name": "node-js-api",
        "version": "1.0.0",
        "description": "node js api project",
        "main": "server.js",
        "scripts": { 
          "start": "node server.js"
        },
        "keywords": [
          "api",
          "node",
          "beginner"
        ],
        "author": "Dragos",
        "license": "ISC"
      }
      
    </pre>
    <p class="text">
      It is now time to test our server, so in the terminal just run
      <span class="snippet">npm start</span>:
    </p>
    <div class="devPic">
      <img src="./img/npm-start-1.png" alt="" class="" />
    </div>
    <p class="text">
      We can already see in the console that the API is running, and we can
      check it if we go to
      <span class="snippet"
        ><a href="http://localhost:5000" target="_blank"
          >http://localhost:5000</a
        ></span
      >.
    </p>
    <p class="text">
      We will now set up one nice dependency called
      <span class="snippet">nodemon</span> which will enable us to have
      hot-reloading (so the server to re-start automatically whenever we change
      something in our files). This is a nice feature which we currently do not
      have, if for instance you try to change something in the API response, so
      make it say: Welcome to our nodeJS API project, save and the refresh the
      webpage, nothing will change unless you stop the server with
      <span class="snippet">ctr + c</span> and restart it by running
      <span class="snippet">npm start</span>.
    </p>
    <p class="text">
      Stop your server (ctr + c) and run the bellow command to install
      <span class="snippet">nodemon</span> as a dev dependency:
    </p>
    <pre class="code">
      npm i -D nodemon --save 
    </pre>
    <p class="text">
      The <span class="snippet">-D</span> flag tells npm to install
      <span class="snippet">nodemon</span> as a dev dependenciy, while the
      <span class="snippet">--save</span> one updates all the other dependencies
      (if needed).
    </p>
    <p class="text">
      Once the command finishes, you can check your
      <span class="snippet">package.json</span> file to see that
      <span class="snippet">nodemon</span> has been added as a dev dependency:
    </p>
    <div class="devPic">
      <img src="./img/nodemon.png" alt="" />
    </div>
    <p class="text">
      Modify the <span class="snippet">start</span> script in
      <span class="snippet">package.json</span> telling it to start the
      <span class="snippet">server.js</span> file with
      <span class="snippet">nodemon</span> instead of node:
    </p>
    <pre class="code">
      {
        "name": "node-js-api",
        "version": "1.0.0",
        "description": "node js api project",
        "main": "server.js",
        "scripts": { 
          "start": "nodemon server.js"
        },
        "keywords": [
          "api",
          "node",
          "beginner"
        ],
        "author": "Dragos",
        "license": "ISC",
        "devDependencies": {
          "nodemon": "^2.0.4"
        }
      }
    </pre>
    <p class="text">
      Now start the server again with <span class="snippet">npm start</span> and
      change something in the response. The server will automatically restart,
      so you don't have to do it manually each time you change something (so you
      only have to refresh the webpage). This may seem trivial, but during
      development it is extremely useful and practical.
    </p>
    <p class="text center bold">Read (from CRUD)</p>
    <p class="text">
      We will have all our 'resources' stored in a
      <span class="snippet">db.json</span> file and we will write and read from
      that file.
    </p>
    <p class="text">
      Start by importing the file system module in our server script. We will
      also set the
      <span class="snippet">Content-Type</span> as
      <span class="snippet">text/html</span> so we can return some html views
      from our API. Finally we will define a second endpoint
      <span class="snippet">/resources</span>:
    </p>
    <pre class="code">
      //import http module for our server
const http = require("http");
//import file system module
const fs = require("fs");

//define port for our server to listen to
const PORT = process.env.port || 5000;

//create server
const server = http.createServer((req, res) => {
  //define url
  const url = req.url;
  //set content type header
  res.setHeader("Content-Type", "text/html");

  switch (url) {
    case "/":
      //write client response
      res.write(`
        &lt;h1&gt;Welcome to our nodeJS API&lt;/h1&gt;
        &lt;p&gt;This is your first endpoint =)&lt;/p&gt;
            `);
      //send client response
      res.end();
      break;
    case "/resources":
      //write client response
      res.write(`
    &lt;h1&gt;Welcome to the resources page&lt;/h1&gt;
    &lt;p&gt;
        Please see below all our 
        current resources:
    &lt;/p&gt;
`);
      //send client response
      res.end();
      break;
  }
});

//log some output to see everything's ok
console.log(`
    Server is running on port: 
    ${PORT} so our API is alive =)`);

//start the server
server.listen(PORT);

    </pre>
    <p class="text">
      Now if you go to
      <span class="snippet"
        ><a href="http://localhost:5000/resources" target="_blank"
          >http://localhost:5000/resources</a
        ></span
      >
      you will see the view from our second endpoint.
    </p>
    <p class="text">
      Our data will be stored in a <span class="snippet">db.json</span> file, so
      create it and paste the below JSON data in it:
    </p>
    <pre class="code">
      {
        "resources": [
          { 
            "text": "test", 
            "id": "1", 
            "date": "2020-09-17" 
          },
          { 
            "text": "test2323", 
            "id": "2", 
            "date": "2020-09-08" 
          },
          { 
            "text": "Test2", 
            "id": "3", 
            "date": "2020-09-15" 
          }
        ]
      }
      
    </pre>
    <p class="text">
      If you have not worked with JSON before, you will see that it is a very
      handy format, which we can use for a bunch of awesome things. If you did
      use it, you'll still enjoy this.
    </p>
    <p class="text">
      We will now create a thrid file now
      <span class="snippet">resource.js</span>. This file will work like a
      'controller' for our resources (if you are familiar with the MVC pattern)
      writing, reading and editing them. This file will only have one method for
      now <span class="snippet">getResources()</span> so let's implement it:
    </p>
    <pre class="code">
const fs = require("fs");
const resource = {
  getAll: (res) => {
    fs.readFile("db.json", "utf8", function (err, data) 
    {
      if (err) throw err;
      if (data !== "") {
        let resources = JSON.parse(data).resources;

        resources.map((r) => {
          res.write(`
            &lt;div 
                style="display:block; 
                margin:auto; border: 2px solid #ccc; 
                text-align:center; 
                width:30rem; 
                margin-bottom:1rem; 
                border-radius:10px;"
            &gt;
                  &lt;p&gt;Resource: ${r.text}&lt;/p&gt;
                  &lt;p&gt;ID: ${r.id} &lt;/p&gt;
                  &lt;p&gt;Date submitted: ${r.date} &lt;/p&gt;
                &lt;/div&gt;
              `);
        });
      } else {
        res.write(`
            &lt;div 
                style="display:block; 
                margin:auto; border: 2px solid #ccc; 
                text-align:center; 
                width:30rem; 
                margin-bottom:1rem; 
                border-radius:10px;"
            &gt;
              &lt;p&gt;No current resources&lt;/p&gt;
            &lt;/div&gt;
          `);
      }

      res.end();
    });
  },
};

module.exports = resource;

    </pre>
    <p class="text">
      Note how this method, uses the response object
      <span class="snippet">res</span> as argument and it simply reads the
      <span class="snippet">db.json</span> file, loops through the resources and
      displays each of them in a div. The request and response objects are
      available in the request listener from
      <span class="snippet">http.createServer((req,res)=>{})</span>
    </p>
    <p class="text">
      Next import the <span class="snippet">resource</span> module into
      <span class="snippet">server.js</span> and call the
      <span class="snippet">getResources()</span> method when the
      <span class="snippet">/resources</span>
      endpoint is hit:
    </p>
    <pre class="code">
//import http module for our server
const http = require("http");
//import file system module
const fs = require("fs");
const resource = require("./resource");

//define port for our server to listen to
const PORT = process.env.port || 5000;

//create server
const server = http.createServer((req, res) => {
  //define url
  const url = req.url;
  //set content type header
  res.setHeader("Content-Type", "text/html");

  switch (url) {
    case "/":
      //write client response
      res.write(`
        &lt;h1&gt;Welcome to our nodeJS API&lt;/h1&gt;
        &lt;p&gt;This is your first endpoint =)&lt;/p&gt;
            `);
      //send client response
      res.end();
      break;
    case "/resources":
      resource.getAll(res);
      break;
  }
});

//log some output to see everything's ok
console.log(`
    Server is running on port: 
    ${PORT} so our API is alive =)`);

//start the server
server.listen(PORT);

    </pre>
    <p class="text">
      Next if you go to
      <span class="snippet"
        ><a href="http://localhost:5000/resources" target="_blank"
          >http://localhost:5000//resources</a
        ></span
      >, you can see all the resources displayed as cards in the browser.
    </p>
    <p class="text">
      Feel free to test the endpoint more by deleting/modifiying/adding some
      more data in <span class="snippet">db.json</span>. Next, put the data back
      and we will start working on the add functionality.
    </p>
    <p class="text center bold">Create (from CRUD)</p>
    <p class="text">
      We will now implement the create functionality for our app. We will need 2
      different requests for this, one will render the form for adding a
      resource and the other one will handle the submit and the processing of
      the data. Create a 3rd route, this time
      <span class="snippet">/resource/add</span> in the
      <span class="snippet">server.js</span> file:
    </p>
    <pre class="code">
      //snippet from server.js
      //add this under the 'resource' case 
      case "/resource/add":
      if (method === "GET") {
        res.write(`
        &lt;h1 
          style="text-align:center; 
          margin:3rem;"
        &gt;
          Add a new resource
        &lt;/h1&gt;
        &lt;form 
          style="display:block; 
          margin:auto; 
          border: 2px solid #ccc; 
          text-align:center; 
          width:30rem; 
          margin-bottom:1rem; 
          padding:2rem!important; 
          font-size:1.5rem!important;" 
          
          action="/resource/add"
          
          method="POST"
        &gt;
          &lt;label for="text"&gt;Resource Text&lt;/label&gt;
          &lt;input name="text" type="text"/&gt;
          &lt;br&gt; &lt;br&gt; 
          &lt;label for="id"&gt;Resource id&lt;/label&gt;
          &lt;input name="id" type="number"/&gt;
          &lt;br&gt; &lt;br&gt;
          &lt;label for="date"&gt;Submission Date&lt;/label&gt;
          &lt;input name="date" type="date"/&gt;
          &lt;br&gt; &lt;br&gt;
          &lt;input 
            style="display:block; 
            margin:auto!important; 
            width:20rem; 
            font-size:2rem;" 
            type="submit" 
            
            value="Add Resource"&gt; 
        &lt;/form&gt;
        `);
        res.end();
      } else if (method === "POST") {
        resource.addResource(req, res);
      }

      break;
    </pre>
    <p class="text">
      Note how we check the <span class="snippet">method</span> variable, to see
      if we have a <span class="snippet">GET</span> or
      <span class="snippet">POST</span> request. The method is a property of the
      request object ( <span class="snippet">req</span> ) We need to define the
      <span class="snippet">method</span> variable so add it right under the url
      in <span class="snippet">server.js</span>:
    </p>
    <pre class="code">
  //define url
  const url = req.url;
  //define method
  const method = req.method;
    </pre>
    <p class="text">
      Now if you go to:

      <a href="http://localhost:5000/resource/add" target="_blank"
        >http://localhost:5000/resource/add</a
      >
      we can see the form in the browser.
    </p>
    <p class="text">
      Let's now implement the <span class="snippet">addResource()</span> method
      in <span class="snippet">resource.js</span>. Note that the method
      basically takes the input from the user, and adds it to the
      <span class="snippet">db.json</span> file, while making sure the id we
      introduce is unique. So we cannot introduce the same id twice:
    </p>
    <pre class="code">
const fs = require("fs");
const resource = {
addResource: (req, res) => {
  const body = [];
  req.on("data", (chunk) => {
    body.push(chunk);
  });

  req.on("end", () => {
    const parsedBody = Buffer
      .concat(body).toString();
    let rawData = parsedBody
      .split("&").map((item) => {
      return item.split("=")[1];
    });

    let dataObj = {};

    dataObj.text = rawData[0].split("+")
                             .join(" ");
    dataObj.id = rawData[1];
    dataObj.date = rawData[2];

fs.readFile("./db.json", "utf8", (err, data) => {
      if (err) {
        throw err;
      }

      let resources;
      let objToWrite = {};
      if (data !== "") {
        let resources = JSON.parse(data).resources;
        var isUnique = true;
        let ids = [];
        resources.map((r) => {
          ids.push(r.id.toString());
        });

        if (ids.includes(dataObj.id)) {
          res.write("ID MUST BE UNIQUE");
          return res.end();
        } else {
          objToWrite = {
            resources,
          };
          objToWrite.resources.push(dataObj);
        }
      } else {
        resources = [];
        resources.push(dataObj);
        objToWrite.resources = resources;
      }

      fs.writeFile(
          "db.json", 
          JSON.stringify(objToWrite), 
          (err) => {});

      res.write("Resource added successfully");
      res.end();
    });
  });
},

getAll: (res) => {
  fs.readFile("db.json", "utf8", function (err, data) 
  {
    if (err) throw err;
    if (data !== "") {
      let resources = JSON.parse(data).resources;

      resources.map((r) => {
        res.write(`
          &lt;div 
              style="display:block; 
              margin:auto; border: 2px solid #ccc; 
              text-align:center; 
              width:30rem; 
              margin-bottom:1rem; 
              border-radius:10px;"
          &gt;
                &lt;p&gt;Resource: ${r.text}&lt;/p&gt;
                &lt;p&gt;ID: ${r.id} &lt;/p&gt;
                &lt;p&gt;Date submitted: ${r.date} &lt;/p&gt;
              &lt;/div&gt;
            `);
      });
    } else {
      res.write(`
          &lt;div 
              style="display:block; 
              margin:auto; border: 2px solid #ccc; 
              text-align:center; 
              width:30rem; 
              margin-bottom:1rem; 
              border-radius:10px;"
          &gt;
            &lt;p&gt;No current resources&lt;/p&gt;
          &lt;/div&gt;
        `);
    }

    res.end();
  });
},
};

module.exports = resource;

    </pre>
    <p class="text">
      Test the adding functionality by adding a new resource. Check that it is
      written in the <span class="snippet">db.json</span> file. Also, try adding
      a second resource with the same id as an existing one. You will see that
      it is not written to the .json file and that you get the 'ID MUST BE
      UNIQUE' response from the server.
    </p>
  </body>
</html>
